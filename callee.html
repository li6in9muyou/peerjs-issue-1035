<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>callee</title>
  </head>
  <body>
    <h1>This is video+audio callee</h1>
    <video id="sourceVideo" playsinline controls loop src="chrome.webm"></video>
    <h2>Received:</h2>
    <video id="received" playsinline controls loop muted></video>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script type="module">
      sourceVideo.addEventListener("canplay", async () => {
        const source = sourceVideo.captureStream();
        const videoTrack = source
          .getTracks()
          .filter((t) => t.kind === "video")[0];
        const audioTrack = source
          .getTracks()
          .filter((t) => t.kind === "audio")[0];
        console.log(
          "source video ready",
          videoTrack,
          audioTrack,
          source.getTracks()
        );

        const getCalledPeer = new Peer("peerjs-issue-1035-getCalled");

        getCalledPeer.on("open", (id) => {
          console.log("getCalledPeer on open", id);
          getCalledPeer.on("call", function (call) {
            call.answer(new MediaStream([videoTrack, audioTrack]));
            call.on("stream", (stream) => {
              console.log("getCall on stream", stream, stream.getTracks());
              received.srcObject = stream;
            });
          });
        });
      });
    </script>
  </body>
</html>
